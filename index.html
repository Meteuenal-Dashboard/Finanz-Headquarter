<!DOCTYPE html>
<html lang="de" class="dark">
<head>
    <meta charset="UTF-8">
    <!-- VIEWPORT FIXED: user-scalable=no prevents zooming issues, viewport-fit=cover handles notches -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Finanz-HQ</title>
    <meta name="theme-color" content="#0f172a">
    
    <!-- PWA / APP META TAGS -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Finanz-HQ">
    <meta name="mobile-web-app-capable" content="yes">
    
    <!-- DATA URI MANIFEST FOR INSTALLABILITY -->
    <link rel="manifest" href="data:application/manifest+json;base64,ewogICJuYW1lIjogIkZpbmFuei1IUSIsCiAgInNob3J0X25hbWUiOiAiRmluYW56LUhRIiwKICAic3RhcnRfdXJsIjogIi4iLAogICJkaXNwbGF5IjogInN0YW5kYWxvbmUiLAogICJiYWNrZ3JvdW5kX2NvbG9yIjogIiMwQjBGMTkiLAogICJ0aGVtZV9jb2xvciI6ICIjMEYxNzJBIgp9">

    <!-- STACK -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'], mono: ['JetBrains Mono', 'monospace'] },
                    colors: {
                        'bg-main': '#0B0F19', 
                        'panel': '#151B2B', 
                        'border': '#2D3748',
                        'accent': '#3182CE', 
                        'success': '#10B981', 
                        'danger': '#EF4444', 
                        'warn': '#F59E0B'
                    },
                    boxShadow: { 'glow': '0 0 20px rgba(59, 130, 246, 0.15)' },
                    padding: { 'safe-bottom': 'env(safe-area-inset-bottom)' }
                }
            }
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap');
        
        body { background-color: #0B0F19; color: #F1F5F9; font-family: 'Inter', sans-serif; overflow: hidden; -webkit-tap-highlight-color: transparent; }
        .glass { background: rgba(21, 27, 43, 0.95); border: 1px solid rgba(255, 255, 255, 0.08); backdrop-filter: blur(12px); border-radius: 12px; }
        .mono { font-family: 'JetBrains Mono', monospace; font-variant-numeric: tabular-nums; }
        
        /* --- TICKER PERFORMANCE ENGINE --- */
        .ticker-wrap { 
            width: 100%; 
            overflow: hidden; 
            background: #0F172A; 
            border-bottom: 1px solid #2D3748; 
            height: 32px; 
            line-height: 32px; 
            display: flex; 
            align-items: center; 
            position: relative; 
            z-index: 60; 
            pointer-events: none;
            user-select: none;
        }
        
        .ticker { 
            display: flex;
            white-space: nowrap; 
            animation-name: ticker;
            animation-timing-function: linear;
            animation-iteration-count: infinite;
            animation-duration: 300s; 
        }
        
        .ticker-item { display: inline-block; padding: 0 2rem; font-size: 11px; font-family: 'JetBrains Mono', monospace; font-weight: 600; color: #94A3B8; }
        .ticker-val { color: white; margin-left: 4px; }
        .ticker-up { color: #10B981; }
        .ticker-down { color: #EF4444; }
        
        @keyframes ticker { 0% { transform: translate3d(0, 0, 0); } 100% { transform: translate3d(-50%, 0, 0); } }
        
        th { font-size: 10px; text-transform: uppercase; color: #94A3B8; padding: 12px; border-bottom: 1px solid #2D3748; text-align: left; background: #151B2B; position: sticky; top: 0; z-index: 10; }
        td { padding: 10px 12px; border-bottom: 1px solid rgba(45, 55, 72, 0.3); font-size: 13px; vertical-align: middle; }
        
        .live-dot { height: 10px; width: 10px; border-radius: 50%; display: inline-block; animation: pulse 1.8s infinite cubic-bezier(0.4, 0, 0.6, 1); flex-shrink: 0; }
        @keyframes pulse { 0% { opacity: 1; transform: scale(1); } 50% { opacity: 0.4; transform: scale(1.15); } 100% { opacity: 1; transform: scale(1); } }
        
        .progress-container { width: 100%; background-color: #1e293b; border-radius: 2px; height: 4px; overflow: hidden; margin-top: 16px; margin-bottom: 12px; }
        .progress-bar { height: 100%; background-color: #3182ce; transition: width 1s ease-in-out; }

        #company-tooltip {
            position: fixed; display: none; z-index: 9999;
            width: 280px; background: rgba(15, 23, 42, 0.98); 
            border: 1px solid #3182CE; border-radius: 8px;
            padding: 0; box-shadow: 0 10px 25px rgba(0,0,0,0.8);
            backdrop-filter: blur(12px); pointer-events: none;
        }

        /* Mobile Nav Styling - FIXED Z-INDEX & BACKGROUND */
        nav.md\:hidden { 
            padding-bottom: max(10px, env(safe-area-inset-bottom)); 
            background: #0B0F19; /* Solid background to prevent see-through */
            border-top: 1px solid #2D3748;
            box-shadow: 0 -4px 20px rgba(0,0,0,0.5);
        }
        .mobile-nav-btn { flex: 1; text-align: center; opacity: 0.5; transition: all 0.2s; color: #94A3B8; }
        .mobile-nav-btn.active { color: #3b82f6; opacity: 1; transform: translateY(-2px); }
        .mobile-nav-btn.active i { text-shadow: 0 0 10px rgba(59, 130, 246, 0.6); }

        /* Custom Scrollbar for better Mobile Experience */
        .custom-scroll::-webkit-scrollbar { width: 4px; height: 4px; }
        .custom-scroll::-webkit-scrollbar-track { background: transparent; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #2D3748; border-radius: 2px; }

        .menu-item-active { background: rgba(59, 130, 246, 0.2); color: #60a5fa; border-left: 4px solid #3b82f6; }
    </style>
</head>
<body class="flex flex-col h-screen select-none bg-bg-main text-white">

    <!-- LIVE TICKER BAR -->
    <div class="ticker-wrap flex-shrink-0">
        <div class="ticker" id="live-ticker-bar">
            <span class="ticker-item uppercase">Initialisierung der Marktdaten...</span>
        </div>
    </div>

    <!-- HEADER -->
    <header class="h-16 bg-panel border-b border-border flex items-center justify-between px-4 md:px-6 sticky top-0 z-40 shadow-2xl flex-shrink-0">
        <div class="flex items-center gap-3 md:gap-4 overflow-hidden">
            <div class="w-9 h-9 md:w-10 md:h-10 bg-gradient-to-br from-blue-700 to-slate-900 rounded-lg flex items-center justify-center border border-white/10 shadow-glow flex-shrink-0">
                <i class="fa-solid fa-building-columns text-accent text-sm md:text-lg"></i>
            </div>
            <div class="flex flex-col min-w-0">
                <h1 class="font-bold text-xs md:text-sm tracking-wide text-white leading-none uppercase truncate">
                    FINANZ-HQ <span class="text-accent" id="header-owner-name">DIR</span> 
                </h1>
                <div class="flex items-center gap-2 text-[10px] text-emerald-400 mt-0.5">
                    <span class="live-dot bg-emerald-500" id="status-dot"></span>
                    <span id="market-status" class="tracking-widest font-bold uppercase text-[9px] md:text-xs">LIVE</span>
                </div>
            </div>
        </div>
        
        <!-- DESKTOP NAV -->
        <nav class="hidden md:flex gap-1 bg-black/20 p-1 rounded-lg border border-white/5">
            <button onclick="App.router('dashboard')" id="nav-dashboard" class="px-5 py-1.5 rounded text-xs font-semibold text-blue-100 bg-blue-900 shadow-md transition-all">Cockpit</button>
            <button onclick="App.router('planning')" id="nav-planning" class="px-5 py-1.5 rounded text-xs font-semibold text-gray-400 hover:text-white transition-all">Master-Plan</button>
            <button onclick="App.router('archive')" id="nav-archive" class="px-5 py-1.5 rounded text-xs font-semibold text-gray-400 hover:text-white transition-all">Archiv</button>
            <button onclick="App.router('ai')" id="nav-ai" class="px-5 py-1.5 rounded text-xs font-semibold text-gray-400 hover:text-purple-400 transition-all flex items-center gap-2"><i class="fa-solid fa-newspaper"></i> News</button>
        </nav>

        <div class="flex items-center gap-2 md:gap-3 flex-shrink-0">
             <div id="sync-indicator" class="text-[9px] font-mono text-emerald-400 hidden uppercase tracking-tighter">Sync...</div>
             
             <!-- QR Code Button -->
             <button onclick="UI.Modals.openShare()" class="bg-slate-800 hover:bg-slate-700 text-blue-100 border border-blue-900 w-8 h-8 md:w-auto md:px-3 md:py-1.5 rounded flex items-center justify-center text-xs font-bold transition shadow-lg">
                <i class="fa-solid fa-qrcode"></i>
            </button>
            
            <!-- UPDATE BUTTON -->
            <button onclick="Market.syncAll(true)" id="btnRefresh" class="bg-emerald-600 hover:bg-emerald-500 text-white w-auto px-3 md:px-4 py-1.5 rounded flex items-center justify-center md:justify-start gap-2 text-xs font-bold transition shadow-lg">
                <i class="fa-solid fa-rotate"></i> <span id="btnRefreshText" class="hidden md:inline">Update</span>
            </button>

            <!-- APP INSTALL BUTTON (MOBILE VISIBLE) -->
            <button onclick="UI.Modals.openShare()" class="md:hidden bg-blue-600 hover:bg-blue-500 text-white w-8 h-8 rounded flex items-center justify-center text-sm font-bold shadow-lg animate-pulse" title="App Installieren">
                <i class="fa-solid fa-download"></i>
            </button>

            <!-- HAMBURGER MENU BUTTON (MOBILE ONLY) -->
            <button onclick="UI.toggleMobileMenu()" class="md:hidden text-white text-2xl px-2 focus:outline-none ml-1">
                <i class="fa-solid fa-bars"></i>
            </button>
        </div>
    </header>

    <!-- MOBILE MENU OVERLAY (FULL SCREEN) -->
    <div id="mobile-menu-overlay" class="hidden fixed inset-0 z-[11000] bg-black/95 backdrop-blur-xl flex flex-col justify-start pt-20 px-6 animate-fade-in md:hidden transition-all duration-300">
        <button onclick="UI.toggleMobileMenu()" class="absolute top-4 right-4 text-gray-400 hover:text-white text-3xl p-2"><i class="fa-solid fa-xmark"></i></button>
        
        <h2 class="text-white text-2xl font-bold mb-8 border-b border-gray-800 pb-4">Menü</h2>
        
        <div class="space-y-4 flex flex-col">
            <button onclick="App.router('dashboard'); UI.toggleMobileMenu()" id="mob-menu-dashboard" class="text-left py-4 px-4 text-lg font-bold text-gray-300 rounded hover:bg-white/5 transition flex items-center gap-4">
                <i class="fa-solid fa-layer-group text-xl w-8 text-center"></i> Cockpit
            </button>
            <button onclick="App.router('planning'); UI.toggleMobileMenu()" id="mob-menu-planning" class="text-left py-4 px-4 text-lg font-bold text-gray-300 rounded hover:bg-white/5 transition flex items-center gap-4">
                <i class="fa-solid fa-bullseye text-xl w-8 text-center"></i> Master-Plan
            </button>
            <button onclick="App.router('archive'); UI.toggleMobileMenu()" id="mob-menu-archive" class="text-left py-4 px-4 text-lg font-bold text-gray-300 rounded hover:bg-white/5 transition flex items-center gap-4">
                <i class="fa-solid fa-box-archive text-xl w-8 text-center"></i> Archiv
            </button>
            <button onclick="App.router('ai'); UI.toggleMobileMenu()" id="mob-menu-ai" class="text-left py-4 px-4 text-lg font-bold text-gray-300 rounded hover:bg-white/5 transition flex items-center gap-4">
                <i class="fa-solid fa-newspaper text-xl w-8 text-center"></i> News & Analysen
            </button>
        </div>

        <div class="mt-auto mb-10 space-y-3">
             <button onclick="UI.Modals.openShare(); UI.toggleMobileMenu()" class="w-full bg-blue-600 hover:bg-blue-500 text-white py-4 rounded-lg font-bold shadow-lg flex items-center justify-center gap-3">
                <i class="fa-solid fa-download"></i> App Installieren / Teilen
            </button>
        </div>
    </div>

    <!-- CONTENT AREA -->
    <main class="flex-1 overflow-y-auto p-3 md:p-8 max-w-[1800px] mx-auto w-full space-y-4 md:space-y-8 pb-10 md:pb-8 custom-scroll" id="main-content">
        
        <!-- DASHBOARD VIEW -->
        <div id="view-dashboard" class="space-y-4 md:space-y-6 animate-fade-in w-full">
            <!-- NETWORTH FOCUS CARD -->
            <div class="glass p-5 md:p-8 border border-emerald-500 flex flex-col items-center justify-center text-center w-full">
                <div class="text-[9px] md:text-[10px] text-gray-400 uppercase font-bold tracking-widest mb-1 md:mb-2">Aktuelles Nettovermögen</div>
                <div class="text-2xl md:text-4xl font-bold text-white mono mb-3 md:mb-4" id="kpi-nav">0,00 €</div>
                
                <div class="w-full max-w-2xl">
                    <div class="progress-container">
                        <div class="progress-bar" id="wealth-progress" style="width: 0%"></div>
                    </div>
                    <div class="flex justify-between items-center text-[10px] md:text-xs font-mono text-gray-500 mt-2">
                        <span>Start</span>
                        <span id="goal-target-text">Ziel: Finanzielle Freiheit</span>
                    </div>
                </div>

                <div class="mt-4 md:mt-6 space-y-1">
                    <div class="text-xs md:text-sm text-gray-300 font-medium">Noch erforderlich: <span id="wealth-needed" class="mono text-white">Berechne...</span></div>
                    <div class="text-[10px] md:text-xs text-gray-500">Voraussichtliche Zielerreichung: <span id="wealth-date" class="mono text-gray-400">Berechne...</span></div>
                </div>
            </div>

            <!-- ACTIVE ASSETS -->
            <div class="glass overflow-hidden border border-blue-900 flex flex-col w-full">
                <div class="px-3 md:px-6 py-3 border-b border-border bg-gray-900/30 flex justify-between items-center flex-wrap gap-2">
                    <h3 class="text-[10px] md:text-xs font-bold text-white uppercase tracking-widest flex items-center gap-2">
                        <i class="fa-solid fa-layer-group text-accent"></i> Portfolio
                    </h3>
                    <div class="flex items-center gap-2">
                        <button id="btn-portfolio-update" onclick="Market.refreshPortfolio()" class="bg-slate-800 hover:bg-slate-700 text-blue-100 px-2 py-1 rounded text-[9px] md:text-[10px] font-bold shadow transition flex items-center gap-1 border border-blue-900">
                            <i class="fa-solid fa-rotate"></i> <span class="hidden sm:inline">Kurse</span>
                        </button>
                        <button onclick="UI.Modals.openSearch()" class="bg-emerald-600 hover:bg-emerald-500 text-white px-3 py-1.5 rounded text-[9px] md:text-[10px] font-bold shadow-lg flex items-center gap-1">
                            <i class="fa-solid fa-plus"></i> <span class="hidden xs:inline">ADD</span>
                        </button>
                    </div>
                </div>
                <!-- TABLE CONTAINER -->
                <div class="overflow-x-auto w-full custom-scroll">
                    <table class="w-full text-left min-w-[600px]">
                        <thead>
                            <tr>
                                <th>Name / Ticker</th>
                                <th>KGV</th>
                                <th class="text-center w-24">Trend</th>
                                <th class="text-right">Menge</th>
                                <th class="text-right text-gray-400">Ø Einstieg</th>
                                <th class="text-right text-accent font-bold">Live (Sheet)</th>
                                <th class="text-right text-white">Wert</th>
                                <th class="text-right text-white">G/V</th>
                                <th class="text-center w-28">Option</th>
                            </tr>
                        </thead>
                        <tbody id="portfolio-body"></tbody>
                    </table>
                </div>
                <div id="empty-portfolio" class="p-10 text-center text-gray-500 text-xs">Keine Assets. Datenbank lädt...</div>
            </div>

            <!-- GLOBAL DB SEARCH (LIVE FILTERED) -->
            <div class="glass overflow-hidden border border-blue-900 w-full">
                <div class="px-3 md:px-6 py-3 border-b border-border bg-gray-900/30 flex flex-col md:flex-row justify-between items-start md:items-center gap-2">
                    <div class="flex items-center justify-between w-full md:w-auto gap-3">
                        <h3 class="text-[10px] md:text-xs font-bold text-gray-400 uppercase tracking-widest flex items-center gap-2">
                            <i class="fa-solid fa-database text-accent"></i> Global DB (NUR LIVE-MÄRKTE)
                        </h3>
                        <span id="db-update-time" class="text-[9px] text-accent font-mono bg-blue-900/30 px-2 py-1 rounded border border-blue-500/30">Warte...</span>
                    </div>
                    <input type="text" id="expert-search" oninput="UI.searchExperts()" placeholder="Suchen..." class="bg-black/40 border border-border rounded px-3 py-1 text-xs text-white outline-none focus:border-accent w-full md:w-64">
                </div>
                <div class="h-80 overflow-y-auto custom-scroll w-full relative">
                    <div id="expert-loading" class="absolute inset-0 bg-gray-900/80 flex items-center justify-center z-10 hidden">
                        <div class="text-accent font-bold animate-pulse">Lade frische Daten...</div>
                    </div>
                    <table class="w-full text-left min-w-[500px]">
                        <tbody id="expert-body"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- PLANNING VIEW -->
        <div id="view-planning" class="hidden space-y-4 md:space-y-6 animate-fade-in w-full">
             <div class="grid grid-cols-1 lg:grid-cols-12 gap-4 md:gap-6">
                <div class="lg:col-span-3 space-y-4">
                    <div class="glass p-4 md:p-5 border border-border">
                        <h3 class="text-xs font-bold text-blue-400 mb-3 uppercase tracking-widest">Master-Plan</h3>
                        <div class="space-y-3 text-xs">
                             <div><label class="block text-emerald-400 font-bold mb-1">Name</label><input id="plan-owner" type="text" class="w-full bg-black/30 border border-emerald-600/50 rounded p-2 text-white outline-none" oninput="Planner.saveName()"></div>
                             <div><label class="block text-gray-400 mb-1">Wunsch-Rente (mtl.)</label><input id="plan-goal" type="number" class="w-full bg-black/30 border border-gray-600 rounded p-2 text-white outline-none" value="2500" oninput="Planner.calc()"></div>
                             <div class="grid grid-cols-2 gap-2">
                                 <div><label class="block text-gray-400 mb-1">Alter</label><input id="plan-age" type="number" class="w-full bg-black/30 border border-gray-600 rounded p-2 text-white outline-none" value="35" oninput="Planner.calc()"></div>
                                 <div><label class="block text-gray-400 mb-1">Zielalter</label><input id="plan-target" type="number" class="w-full bg-black/30 border border-gray-600 rounded p-2 text-white outline-none" value="55" oninput="Planner.calc()"></div>
                             </div>
                             <div><label class="block text-gray-400 mb-1">Sparrate mtl. (€)</label><input id="plan-save" type="number" class="w-full bg-black/30 border border-gray-600 rounded p-2 text-white outline-none" value="1000" oninput="Planner.calc()"></div>
                             <div><label class="block text-slate-400 mb-1">Erw. Rendite (% p.a.)</label><input id="plan-return" type="number" class="w-full bg-black/30 border border-gray-600 rounded p-2 text-white outline-none" value="7.0" oninput="Planner.calc()"></div>
                             <div><label class="block text-slate-400 mb-1">Dividendenrendite (%)</label><input id="plan-yield" type="number" class="w-full bg-black/30 border border-gray-600 rounded p-2 text-white outline-none" value="3.5" step="0.1" oninput="Planner.calc()"></div>
                        </div>
                    </div>
                </div>
                <div class="lg:col-span-9 space-y-4">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-3 md:gap-4">
                        <div class="glass p-4 border-t-2 border-emerald-500">
                             <div class="text-[9px] text-gray-500 uppercase font-bold tracking-widest">Zielvermögen</div>
                             <div class="text-xl font-bold mono mt-1" id="plan-wealth">0 €</div>
                        </div>
                        <div class="glass p-4 border-t-2 border-purple-500">
                             <div class="text-[9px] text-gray-500 uppercase font-bold tracking-widest">mtl. Dividende</div>
                             <div class="text-xl font-bold text-purple-400 mono mt-1" id="plan-passive">0 €</div>
                        </div>
                        <div class="glass p-4 border-t-2 border-blue-500">
                             <div class="text-[9px] text-slate-500 uppercase font-bold" id="plan-gap-label">Status Lücke</div>
                             <div class="text-xl font-bold text-blue-400 mono mt-1" id="plan-gap">Berechne...</div>
                        </div>
                    </div>
                    <div class="glass p-4 h-64 md:h-96 border border-border">
                        <canvas id="planChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- NEWS VIEW -->
        <div id="view-ai" class="hidden h-full animate-fade-in w-full">
             <div class="glass p-4 md:p-6 max-w-6xl mx-auto border-t-2 border-purple-500 flex flex-col h-auto md:h-[600px]">
                <div class="flex items-center gap-4 mb-4 md:mb-6 border-b border-border pb-4">
                    <div class="w-10 h-10 bg-purple-900/30 rounded-full flex items-center justify-center text-purple-400 text-xl border border-purple-500/20"><i class="fa-solid fa-newspaper"></i></div>
                    <div><h2 class="text-base md:text-lg font-bold text-white tracking-tight">Portfolio News</h2><p class="text-[10px] text-emerald-400 font-bold uppercase tracking-widest">Aggregated Feed</p></div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-12 gap-4 h-full overflow-hidden">
                    <div class="md:col-span-4 border-b md:border-b-0 md:border-r border-border pb-4 md:pb-0 md:pr-4 overflow-y-auto custom-scroll h-48 md:h-auto" id="ai-asset-list"></div>
                    <div class="md:col-span-8 flex flex-col items-center justify-center text-center p-4 md:p-8" id="ai-detail-view">
                        <div class="w-12 h-12 md:w-16 md:h-16 bg-gray-800 rounded-full flex items-center justify-center mb-4 text-gray-600"><i class="fa-solid fa-magnifying-glass text-xl md:text-2xl"></i></div>
                        <h3 class="text-base md:text-lg font-bold text-white">Wähle ein Asset</h3>
                        <p class="text-xs text-gray-500">Klicke links auf ein Asset für Details.</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- ARCHIVE VIEW -->
        <div id="view-archive" class="hidden space-y-4 md:space-y-6 animate-fade-in w-full">
             <div class="glass overflow-hidden border border-border">
                <div class="px-4 py-3 border-b border-border bg-gray-900/30 flex justify-between items-center">
                    <h3 class="text-[10px] md:text-xs font-bold text-warn uppercase tracking-widest">Realisierte Historie</h3>
                    <span class="text-[10px] md:text-xs font-mono text-gray-400" id="archive-total-pl">G/V: 0,00 €</span>
                </div>
                <div class="overflow-x-auto w-full custom-scroll">
                    <table class="w-full text-left min-w-[600px]">
                        <thead>
                            <tr><th class="pl-6">Datum</th><th>Asset</th><th>Grund</th><th class="text-right">Menge</th><th class="text-right">Ergebnis</th><th class="text-center w-24">Option</th></tr>
                        </thead>
                        <tbody id="archive-body"></tbody>
                    </table>
                </div>
                <div id="empty-archive" class="hidden p-10 text-center text-gray-500 text-xs">Leer.</div>
            </div>
        </div>

    </main>

    <!-- COMPANY TOOLTIP -->
    <div id="company-tooltip">
        <div class="bg-gray-900/90 border-b border-blue-500 p-3 flex justify-between items-center rounded-t-lg">
            <h4 class="font-bold text-white text-sm" id="tip-name">---</h4>
            <span class="text-[9px] bg-blue-900 px-1.5 rounded text-blue-200" id="tip-ticker">---</span>
        </div>
        <div class="p-3 grid grid-cols-2 gap-2 text-[10px] text-gray-300">
            <div>ISIN: <span id="tip-isin" class="text-white mono">---</span></div>
            <div>Sektor: <span id="tip-sector" class="text-white">---</span></div>
            <div>Region: <span id="tip-region" class="text-white">---</span></div>
            <div>Dividende: <span id="tip-div" class="text-emerald-400 font-bold">---</span></div>
            <div>Preis: <span id="tip-price" class="text-white mono font-bold">---</span></div>
            <div>Trend: <span id="tip-change" class="font-bold">---</span></div>
        </div>
    </div>

    <!-- MODALS -->
    
    <!-- SEARCH MODAL -->
    <div id="modal-search" class="hidden fixed inset-0 bg-black/95 backdrop-blur-md z-[10000] flex justify-center pt-12 md:pt-20">
        <div class="bg-panel border border-border w-full max-w-lg rounded-xl shadow-2xl overflow-hidden h-fit mx-4 flex flex-col max-h-[80vh]">
            <div class="p-4 border-b border-border flex justify-between items-center bg-gray-900/50 flex-shrink-0">
                <h3 class="text-sm font-bold text-white uppercase">Asset suchen</h3>
                <button onclick="UI.Modals.close()" class="text-gray-500 hover:text-white transition p-2"><i class="fa-solid fa-xmark text-lg"></i></button>
            </div>
            <div class="p-4 md:p-6 overflow-y-auto">
                <input id="search-input" type="text" class="w-full bg-black/40 border border-border rounded p-3 text-white text-sm outline-none focus:border-accent" placeholder="Suche nach Name, Ticker oder ISIN..." onkeyup="UI.searchInModal()">
                <div id="search-results" class="mt-4 space-y-1 max-h-60 overflow-y-auto custom-scroll"></div>
            </div>
        </div>
    </div>

    <!-- SHARE MODAL -->
    <div id="modal-share" class="hidden fixed inset-0 bg-black/95 backdrop-blur-sm z-[10000] flex justify-center items-center">
        <div class="bg-panel border border-border w-full max-w-sm rounded-xl p-6 md:p-8 shadow-2xl text-center mx-4">
            <h3 class="text-lg md:text-xl font-bold text-white mb-4">Teilen & Mobile</h3>
            
            <div id="qrcode" class="bg-white p-2 rounded mx-auto mb-6 w-32 h-32 flex items-center justify-center"></div>
            
            <button onclick="UI.Modals.shareWhatsApp()" class="bg-green-600 hover:bg-green-500 text-white w-full py-3 rounded text-sm font-bold mb-3 flex items-center justify-center gap-2 shadow-lg">
                <i class="fa-brands fa-whatsapp text-lg"></i> Per WhatsApp senden
            </button>
            
            <div id="install-hint" class="bg-gray-800 p-3 rounded text-left text-xs text-gray-300 mb-4 border border-gray-700">
                <div class="font-bold text-white mb-1">Für Vollbild-Modus:</div>
                <div class="flex items-center gap-2 mb-1"><i class="fa-brands fa-apple text-gray-400"></i> Safari: "Teilen" <i class="fa-solid fa-arrow-up-from-bracket"></i> -> "Zum Home-Bildschirm"</div>
                <div class="flex items-center gap-2"><i class="fa-brands fa-android text-gray-400"></i> Chrome: Menü <i class="fa-solid fa-ellipsis-vertical"></i> -> "App installieren"</div>
            </div>

            <button onclick="UI.Modals.close()" class="bg-slate-700 text-white py-3 px-6 rounded text-xs font-bold w-full">Schließen</button>
        </div>
    </div>

    <!-- DETAIL MODAL (ADD NEW) -->
    <div id="modal-add-details" class="hidden fixed inset-0 bg-black/90 z-[11000] flex justify-center items-center">
        <div class="bg-panel border border-border w-full max-w-md rounded-xl p-6 shadow-2xl mx-4">
            <h3 class="text-lg font-bold text-white mb-4">Position hinzufügen</h3>
            <form onsubmit="Core.addExec(event)" class="space-y-4">
                <input type="hidden" id="final-index">
                <div class="grid grid-cols-2 gap-4">
                    <div><label class="block text-[10px] text-accent font-bold uppercase mb-1">Menge</label><input id="final-qty" type="number" step="any" class="w-full bg-black/40 border border-border rounded p-2 text-white outline-none" required inputmode="decimal"></div>
                    <div><label class="block text-[10px] text-accent font-bold uppercase mb-1">Kaufpreis (€)</label><input id="final-buy" type="number" step="any" class="w-full bg-black/40 border border-border rounded p-2 text-white outline-none" required inputmode="decimal"></div>
                </div>
                <div class="flex justify-end gap-3 pt-4">
                    <button type="button" onclick="UI.Modals.close()" class="text-xs text-gray-500 p-2">Abbrechen</button>
                    <button type="submit" class="bg-success text-white px-6 py-2 rounded text-xs font-bold shadow-lg">SPEICHERN</button>
                </div>
            </form>
        </div>
    </div>

    <!-- BUY MORE MODAL -->
    <div id="modal-buy-more" class="hidden fixed inset-0 bg-black/90 z-[11000] flex justify-center items-center">
        <div class="bg-panel border border-border w-full max-w-md rounded-xl p-6 shadow-2xl mx-4">
            <h3 class="text-lg font-bold text-emerald-400 mb-4">Nachkaufen</h3>
            <p class="text-xs text-gray-400 mb-4">Der Ø-Preis wird neu berechnet.</p>
            <form onsubmit="Core.buyMoreExec(event)" class="space-y-4">
                <input type="hidden" id="buy-more-idx">
                <div class="grid grid-cols-2 gap-4">
                    <div><label class="block text-[10px] text-emerald-400 font-bold uppercase mb-1">Neue Menge</label><input id="buy-more-qty" type="number" step="any" class="w-full bg-black/40 border border-border rounded p-2 text-white outline-none" required inputmode="decimal"></div>
                    <div><label class="block text-[10px] text-emerald-400 font-bold uppercase mb-1">Preis (€)</label><input id="buy-more-price" type="number" step="any" class="w-full bg-black/40 border border-border rounded p-2 text-white outline-none" required inputmode="decimal"></div>
                </div>
                <div class="flex justify-end gap-3 mt-6">
                    <button type="button" onclick="UI.Modals.close()" class="text-xs font-bold text-gray-400 p-2">Abbrechen</button>
                    <button type="submit" class="bg-emerald-600 text-white px-6 py-2 rounded text-xs font-bold">KAUFEN</button>
                </div>
            </form>
        </div>
    </div>

    <!-- SELL MODAL -->
    <div id="modal-sell" class="hidden fixed inset-0 bg-black/90 z-[11000] flex justify-center items-center">
        <div class="bg-panel border border-border w-full max-w-md rounded-xl p-6 shadow-2xl mx-4">
            <h3 class="text-lg font-bold text-white mb-4">Verkauf archivieren</h3>
            <form onsubmit="Core.sellExec(event)">
                <input type="hidden" id="sell-idx">
                <div class="space-y-4">
                    <div>
                        <label class="block text-[10px] font-bold text-orange-400 uppercase mb-1">Menge (Max: <span id="sell-max-qty">0</span>)</label>
                        <input id="sell-qty" type="number" step="any" class="w-full bg-black/40 border border-border rounded p-2 text-white outline-none" required inputmode="decimal">
                    </div>
                    <div><label class="block text-[10px] font-bold text-orange-400 uppercase mb-1">Verkaufspreis (€)</label><input id="sell-price" type="number" step="any" class="w-full bg-black/40 border border-border rounded p-2 text-white outline-none" required inputmode="decimal"></div>
                    <div><label class="block text-[10px] font-bold text-orange-400 uppercase mb-1">Grund</label><textarea id="sell-reason" class="w-full bg-black/40 border border-border rounded p-2 text-white text-xs h-20 outline-none" required placeholder="Notiz..."></textarea></div>
                </div>
                <div class="flex justify-end gap-3 mt-6">
                    <button type="button" onclick="UI.Modals.close()" class="text-xs font-bold text-gray-400 p-2">Abbrechen</button>
                    <button type="submit" class="bg-danger text-white px-6 py-2 rounded text-xs font-bold">BESTÄTIGEN</button>
                </div>
            </form>
        </div>
    </div>

    <!-- RESTORE MODAL -->
    <div id="modal-restore" class="hidden fixed inset-0 bg-black/90 z-[11000] flex justify-center items-center">
        <div class="bg-panel border border-border w-full max-w-md rounded-xl p-6 shadow-2xl mx-4">
            <h3 class="text-lg font-bold text-blue-400 mb-4">Wiederherstellen</h3>
            <form onsubmit="Core.restoreExec(event)" class="space-y-4">
                <input type="hidden" id="restore-idx">
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-[10px] text-blue-400 font-bold uppercase mb-1">Menge (Max: <span id="restore-max-qty"></span>)</label>
                        <input id="restore-qty" type="number" step="any" class="w-full bg-black/40 border border-border rounded p-2 text-white outline-none" required inputmode="decimal">
                    </div>
                    <div><label class="block text-[10px] text-blue-400 font-bold uppercase mb-1">Einstieg (€)</label><input id="restore-price" type="number" step="any" class="w-full bg-black/40 border border-border rounded p-2 text-white outline-none" required inputmode="decimal"></div>
                </div>
                <div class="flex justify-end gap-3 mt-6">
                    <button type="button" onclick="UI.Modals.close()" class="text-xs font-bold text-gray-400 p-2">Abbrechen</button>
                    <button type="submit" class="bg-blue-600 text-white px-6 py-2 rounded text-xs font-bold">OK</button>
                </div>
            </form>
        </div>
    </div>

<script>
/** * FINANCE OS V94.51 - FINAL COMPLETE */

const CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTWfyYAd3wNIW97IMvxxjkRVzXQGvXCSyr0-1EVZFTJ49iYown130Z4K2DF_FxORvM4Ssm0w4jnmGAJ/pub?gid=0&single=true&output=csv';

const Store = {
    state: {
        assets: JSON.parse(localStorage.getItem('fos_port_v94_assets')) || [], 
        history: JSON.parse(localStorage.getItem('fos_port_v94_history')) || [], 
        historyGraph: JSON.parse(localStorage.getItem('fos_port_v94_graph')) || [],
        masterData: [], 
        owner: localStorage.getItem('fos_owner') || "DIR",
        plan: JSON.parse(localStorage.getItem('fos_plan')) || {goal:2500, age:42, target:55, save:1500, ret:8.0, yld:4.0}
    },
    commit: () => {
        localStorage.setItem('fos_port_v94_assets', JSON.stringify(Store.state.assets));
        localStorage.setItem('fos_port_v94_history', JSON.stringify(Store.state.history));
        localStorage.setItem('fos_port_v94_graph', JSON.stringify(Store.state.historyGraph));
        localStorage.setItem('fos_owner', Store.state.owner);
        localStorage.setItem('fos_plan', JSON.stringify(Store.state.plan));
    }
};

const Planner = {
    saveName: () => { Store.state.owner = document.getElementById('plan-owner').value; Store.commit(); UI.render(); },
    calc: () => {
        const p = Store.state.plan;
        const age = parseFloat(document.getElementById('plan-age') ? document.getElementById('plan-age').value : p.age) || 35;
        const targetAge = parseFloat(document.getElementById('plan-target') ? document.getElementById('plan-target').value : p.target) || 55;
        const save = parseFloat(document.getElementById('plan-save') ? document.getElementById('plan-save').value : p.save) || 1000;
        const rate = (parseFloat(document.getElementById('plan-return') ? document.getElementById('plan-return').value : p.ret) || 7.0) / 100;
        const yld = (parseFloat(document.getElementById('plan-yield') ? document.getElementById('plan-yield').value : p.yld) || 3.5) / 100;
        const goal = parseFloat(document.getElementById('plan-goal') ? document.getElementById('plan-goal').value : p.goal) || 2500;

        const startCap = Store.state.assets.reduce((a,b) => {
            const price = b.livePrice > 0 ? b.livePrice : b.buyPrice;
            return a + (b.qty * price);
        }, 0);
        
        let wealth = startCap; 
        const years = Math.max(0, targetAge - age); 
        const data = []; 
        const labels = [];
        
        for(let i=0; i<=years; i++) {
            data.push(wealth); labels.push(age + i);
            wealth = (wealth + (save * 12)) * (1 + rate);
        }

        const wealthEl = document.getElementById('plan-wealth');
        if(wealthEl) wealthEl.innerText = wealth.toLocaleString('de-DE', {style:'currency', currency:'EUR'});
        
        const passive = (wealth * yld) / 12;
        const passiveEl = document.getElementById('plan-passive');
        if(passiveEl) passiveEl.innerText = passive.toLocaleString('de-DE', {style:'currency', currency:'EUR'});
        
        const gap = goal - passive;
        const gapEl = document.getElementById('plan-gap');
        const gapLabel = document.getElementById('plan-gap-label');
        if(gapEl && gapLabel) {
            if(gap > 0) {
                gapLabel.innerText = "Status Lücke";
                gapEl.innerText = gap.toLocaleString('de-DE', {style:'currency', currency:'EUR'});
                gapEl.className = "text-xl font-bold text-blue-400 mono mt-1";
            } else {
                gapLabel.innerText = "Status Überschuss";
                gapEl.innerText = "+" + Math.abs(gap).toLocaleString('de-DE', {style:'currency', currency:'EUR'});
                gapEl.className = "text-xl font-bold text-emerald-400 mono mt-1";
            }
        }
        
        Planner.renderChart(labels, data);
        
        Store.state.plan = {goal, age, target: targetAge, save, ret: rate*100, yld: yld*100};
        Store.commit();
        
        const dashboardTarget = document.getElementById('goal-target-text');
        const dashboardProgress = document.getElementById('wealth-progress');
        
        if(dashboardTarget) {
            dashboardTarget.innerText = `Ziel: ${wealth.toLocaleString('de-DE', {maximumFractionDigits:0})} €`;
        }
        if(dashboardProgress && wealth > 0) {
            const progress = Math.min((startCap / wealth) * 100, 100);
            dashboardProgress.style.width = `${progress}%`;
        }
    },
    renderChart: (labels, data) => {
        const ctx = document.getElementById('planChart'); if(!ctx) return;
        if(Planner.chart) Planner.chart.destroy();
        Planner.chart = new Chart(ctx.getContext('2d'), { 
            type: 'line', 
            data: { 
                labels: labels, 
                datasets: [{ label: 'Vermögen', data: data, borderColor: '#3b82f6', backgroundColor: 'rgba(59, 130, 246, 0.1)', fill: true, tension: 0.4 }] 
            }, 
            options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { display: false }, x: { ticks: { color: '#475569' } } } } 
        });
    }
};

const AI = {
    render: () => {
        const list = document.getElementById('ai-asset-list');
        if(!list) return;
        list.innerHTML = '';
        Store.state.assets.forEach((a, i) => {
            const btn = document.createElement('button');
            btn.className = "w-full p-4 border-b border-border text-left hover:bg-white/5 transition flex flex-col group";
            btn.innerHTML = `<span class="font-bold text-sm group-hover:text-accent">${a.name}</span><span class="text-[10px] text-gray-500 uppercase">${a.isin || a.ticker}</span>`;
            btn.onclick = () => AI.showDetail(i);
            list.appendChild(btn);
        });
    },
    showDetail: (idx) => {
        const a = Store.state.assets[idx];
        let cleanTicker = a.ticker || "";
        if (cleanTicker && cleanTicker.includes(':')) {
            cleanTicker = cleanTicker.split(':')[1];
        }
        const nameForYahoo = a.name; 
        const detailView = document.getElementById('ai-detail-view');
        if(!detailView) return;
        detailView.innerHTML = `
            <div class="w-full text-left bg-slate-900/50 p-4 md:p-6 rounded-xl border border-border animate-fade-in">
                <h3 class="text-xl md:text-2xl font-bold text-white mb-1">${a.name}</h3>
                <div class="text-xs md:text-sm text-accent mb-6 uppercase font-mono">Ticker: ${a.ticker} | ${a.sector}</div>
                <div class="grid grid-cols-1 gap-4">
                    <a href="https://www.onvista.de/suche?searchValue=${encodeURIComponent(cleanTicker)}" target="_blank" class="p-4 md:p-6 glass transform transition-all duration-300 hover:-translate-y-1 hover:scale-105 hover:shadow-glow hover:bg-orange-600/20 border-orange-500/30 flex items-center justify-center gap-4 group">
                        <i class="fa-solid fa-chart-line text-orange-400 text-2xl md:text-3xl group-hover:scale-110 transition"></i>
                        <div class="text-left"><div class="font-bold text-base md:text-lg">Onvista</div><div class="text-[10px] md:text-xs text-gray-500">News & Analysen</div></div>
                    </a>
                    <a href="https://de.finance.yahoo.com/lookup?s=${encodeURIComponent(nameForYahoo)}" target="_blank" class="p-4 md:p-6 glass transform transition-all duration-300 hover:-translate-y-1 hover:scale-105 hover:shadow-glow hover:bg-purple-600/20 border-purple-500/30 flex items-center justify-center gap-4 group">
                        <i class="fa-brands fa-yahoo text-purple-400 text-2xl md:text-3xl group-hover:scale-110 transition"></i>
                        <div class="text-left"><div class="font-bold text-base md:text-lg">Yahoo Finance</div><div class="text-[10px] md:text-xs text-gray-500">Internationale News</div></div>
                    </a>
                    <a href="https://www.google.com/finance/quote/${encodeURIComponent(cleanTicker)}" target="_blank" class="p-4 md:p-6 glass transform transition-all duration-300 hover:-translate-y-1 hover:scale-105 hover:shadow-glow hover:bg-blue-600/20 border-blue-500/30 flex items-center justify-center gap-4 group">
                        <i class="fa-brands fa-google text-blue-400 text-2xl md:text-3xl group-hover:scale-110 transition"></i>
                        <div class="text-left"><div class="font-bold text-base md:text-lg">Google Finanzen</div><div class="text-[10px] md:text-xs text-gray-500">Echtzeit-Daten</div></div>
                    </a>
                </div>
            </div>
        `;
    }
};

const UI = {
    toggleMobileMenu: () => {
        const menu = document.getElementById('mobile-menu-overlay');
        if(menu) menu.classList.toggle('hidden');
    },

    render: () => {
        const ownerEl = document.getElementById('header-owner-name');
        if(ownerEl) ownerEl.innerText = Store.state.owner;
        
        const tb = document.getElementById('portfolio-body');
        const empty = document.getElementById('empty-portfolio');
        if(!tb) return;
        tb.innerHTML = '';
        
        let totVal=0;
        
        Store.state.assets.forEach((s, i) => {
            const SHEET_PRICE_ONLY = (typeof s.livePrice === 'number') ? s.livePrice : 0.00;
            const USER_BUY_PRICE = s.buyPrice || 0.00;
            const val = s.qty * SHEET_PRICE_ONLY;
            totVal += val;

            const chg = s.dayChg || 0;
            const colorClass = chg >= 0 ? 'text-success' : 'text-danger';
            const invest = s.qty * USER_BUY_PRICE;
            const gain = val - invest;
            const gainClass = gain >= 0 ? 'text-success' : 'text-danger';
            const gainSign = gain >= 0 ? '+' : '';
            const displayLive = SHEET_PRICE_ONLY > 0 ? SHEET_PRICE_ONLY.toFixed(2) + ' €' : '<span class="text-orange-500 animate-pulse">Laden...</span>';

            let kgvClass = "text-gray-400";
            const k = parseFloat(s.kgv);
            if (k > 0) {
                if (k < 15) kgvClass = "text-success font-bold";
                else if (k > 25) kgvClass = "text-danger font-bold";
            }

            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td class="font-bold">
                    <span onclick="UI.Modals.openBuyMore(${i})" class="hover:text-accent transition cursor-pointer" onmouseenter="UI.showCompanyDetails(event, ${i}, 'portfolio')" onmouseleave="UI.hideCompanyDetails()">${s.name}</span>
                    <div class="text-[9px] text-gray-500 font-mono uppercase">Ticker: ${s.ticker}</div>
                </td>
                <td class="text-xs ${kgvClass}">${s.kgv || '-'}</td>
                <td class="text-center text-xs font-bold ${colorClass}">${chg.toFixed(2)}%</td>
                <td class="text-right mono text-xs font-medium">${s.qty.toLocaleString()}</td>
                <td class="text-right mono text-xs text-gray-400">${USER_BUY_PRICE.toFixed(2)} €</td>
                <td class="text-right mono text-xs font-bold ${colorClass}">${displayLive}</td>
                <td class="text-right mono text-xs font-bold ${colorClass}">${val.toLocaleString('de-DE', {minimumFractionDigits: 2})} €</td>
                <td class="text-right mono text-xs font-bold ${gainClass}">${gainSign}${gain.toLocaleString('de-DE', {minimumFractionDigits: 2})} €</td>
                <td class="text-center">
                    <div class="flex justify-center gap-2">
                        <button onclick="UI.Modals.openBuyMore(${i})" class="text-emerald-500 hover:text-emerald-400 p-1" title="Nachkaufen"><i class="fa-solid fa-plus-circle"></i></button>
                        <button onclick="UI.Modals.openSell(${i})" class="text-gray-500 hover:text-warn p-1" title="Verkaufen"><i class="fa-solid fa-box-archive"></i></button>
                        <button onclick="if(confirm('Position löschen?')){Store.state.assets.splice(${i},1); Store.commit(); UI.render();}" class="text-gray-500 hover:text-danger p-1" title="Löschen"><i class="fa-solid fa-trash"></i></button>
                    </div>
                </td>
            `;
            tb.appendChild(tr);
        });

        if(empty) empty.classList.toggle('hidden', Store.state.assets.length > 0);
        
        const kpiNav = document.getElementById('kpi-nav');
        if(kpiNav) kpiNav.innerText = totVal.toLocaleString('de-DE', {style:'currency', currency:'EUR'});

        const plan = Store.state.plan;
        const age = parseFloat(plan.age) || 35;
        const targetAge = parseFloat(plan.target) || 55;
        const save = parseFloat(plan.save) || 1000;
        const rate = (parseFloat(plan.ret) || 7.0) / 100;
        
        let projectedWealth = totVal; 
        const years = Math.max(0, targetAge - age);
        
        for(let i=0; i<=years; i++) { 
             projectedWealth = (projectedWealth + (save * 12)) * (1 + rate);
        }

        const totalGoal = projectedWealth;
        const targetYear = new Date().getFullYear() + years;
        
        const progress = totalGoal > 0 ? Math.min((totVal / totalGoal) * 100, 100) : 0;
        document.getElementById('wealth-progress').style.width = `${progress}%`;
        document.getElementById('goal-target-text').innerText = `Ziel: ${totalGoal.toLocaleString('de-DE', {maximumFractionDigits:0})} €`;

        const missing = totalGoal - totVal;
        const neededEl = document.getElementById('wealth-needed');
        if(missing <= 0) {
            neededEl.innerText = "ZIEL ERREICHT";
            neededEl.classList.add('text-success');
        } else {
            neededEl.innerText = missing.toLocaleString('de-DE', {style:'currency', currency:'EUR'});
            neededEl.classList.remove('text-success');
        }

        const dateEl = document.getElementById('wealth-date');
        dateEl.innerText = "Zieljahr: " + targetYear;
        
        Planner.calc(); 
        UI.renderArchive();
        if (typeof AI !== 'undefined' && AI.render) AI.render();
    },

    hideCompanyDetails: () => {
        document.getElementById('company-tooltip').style.display = 'none';
    },

    renderExperts: (filter = "") => {
        const tb = document.getElementById('expert-body');
        if(!tb) return;
        tb.innerHTML = '';
        
        // 1. FILTER: STRICT MARKET HOURS CHECK
        // Logic: Check Ticker Prefix & Name to detect market. Treat ambiguous as US (Hidden in Morning).
        
        const isAssetLive = (asset) => {
            const now = new Date();
            const day = now.getDay();
            if (day === 0 || day === 6) return false; // Weekend closed

            // Device time in minutes (0 - 1439)
            const mins = now.getHours() * 60 + now.getMinutes();
            
            // Normalize Data
            const fullT = (asset.fullTicker || '').toUpperCase();
            const r = (asset.region || '').toUpperCase();
            const n = (asset.name || '').toUpperCase();
            
            // 1. Explicit EU Indicators (Germany/Europe)
            // - Region contains Germany/Europa
            // - Ticker has prefix XETRA, FRA, ETR
            // - Name contains typical DE legal forms: AG, SE (careful with SE), GMBH
            const isEU = 
                r.includes('DEUTSCHLAND') || r.includes('GERMANY') || r.includes('EUROPA') || r.includes('EUROPE') ||
                fullT.includes('XETRA') || fullT.includes('FRA') || fullT.includes('ETR') || fullT.includes('BER') ||
                n.includes(' AG') || n.includes(' GMBH') || (n.includes(' SE') && !n.includes('ENTERTAINMENT')); // Exclude some US SEs

            // 2. Explicit US Indicators
            const isUS = 
                r.includes('USA') || r.includes('AMERIKA') || r.includes('STATES') ||
                fullT.includes('NASDAQ') || fullT.includes('NYSE') || fullT.includes('AMEX') ||
                n.includes(' INC') || n.includes(' CORP') || n.includes(' LLC');

            // 3. Time Logic
            // EU: 08:00 (480 min) - 22:00 (1320 min) (Including L&S / Tradegate times)
            const openEU = mins >= 480 && mins <= 1320;
            
            // US: 15:30 (930 min) - 22:00 (1320 min)
            const openUS = mins >= 930 && mins <= 1320;

            if (isEU) return openEU;
            if (isUS) return openUS;

            // 4. Ambiguous Case (No clear region/ticker)
            // DEFAULT RULE: If we don't know, assume it's a Global/US stock.
            // WHY? Because displaying a US stock at 10 AM with Friday's price looks "broken".
            // displaying a German stock at 10 AM is fine.
            // Hiding a German stock is better than showing a wrong US stock.
            // So we apply US hours (strict) to anything ambiguous.
            
            return openUS; 
        };

        let displayList = Store.state.masterData.filter(a => isAssetLive(a));
        
        if (filter) {
            const query = filter.toLowerCase();
            displayList = displayList.filter(a => 
                a.name.toLowerCase().includes(query) || 
                a.isin.toLowerCase().includes(query) || 
                a.ticker.toLowerCase().includes(query)
            ).slice(0, 50);
        } else {
            const sorted = [...displayList].sort((a, b) => b.change - a.change);
            const winners = sorted.slice(0, 25);
            const losers = sorted.slice(-25).reverse();
            displayList = [...winners, ...losers];
        }

        if (displayList.length === 0) {
            tb.innerHTML = `
                <tr>
                    <td colspan="6" class="p-10 text-center text-gray-500 text-xs flex flex-col items-center">
                        <i class="fa-solid fa-clock text-2xl mb-2 text-blue-500"></i>
                        <span class="font-bold text-gray-300">Märkte laden...</span>
                        <span class="text-[10px] mt-1 text-gray-500">Keine aktiven Trades gefunden.</span>
                        <span class="text-[9px] text-gray-600 mt-1">US-Start: 15:30 Uhr</span>
                    </td>
                </tr>`;
            return;
        }

        displayList.forEach(a => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td class="pl-2 md:pl-6 text-[10px] text-gray-500 font-mono">${a.id}</td>
                <td class="font-medium text-gray-300">
                     <span onclick="UI.Modals.openDetails(${a.id})" class="hover:text-accent transition cursor-pointer" onmouseenter="UI.showCompanyDetails(event, '${a.id}', 'master')" onmouseleave="UI.hideCompanyDetails()">${a.name}</span>
                </td>
                <td class="text-[10px] mono text-accent uppercase hidden xs:table-cell">${a.ticker}</td>
                <td class="text-right mono text-xs">${a.price > 0 ? a.price.toFixed(2) + ' €' : '-'}</td>
                <td class="text-right mono text-xs font-bold ${a.change >= 0 ? 'text-success' : 'text-danger'}">${a.change.toFixed(2)}%</td>
                <td class="text-right"><button onclick="UI.Modals.openDetails(${a.id})" class="text-accent hover:text-white px-2 md:px-4 transition active:scale-90"><i class="fa-solid fa-plus-circle text-lg"></i></button></td>
            `;
            tb.appendChild(tr);
        });
    },

    searchExperts: () => UI.renderExperts(document.getElementById('expert-search').value),

    searchInModal: () => {
        const q = document.getElementById('search-input').value.toLowerCase();
        const res = document.getElementById('search-results');
        if(!res) return;
        res.innerHTML = "";
        if(q.length < 2) return;
        Store.state.masterData.filter(a => a.name.toLowerCase().includes(q) || a.isin.toLowerCase().includes(q)).slice(0, 10).forEach(m => {
            const div = document.createElement('div');
            div.className = "p-3 bg-gray-800 hover:bg-gray-700 rounded border border-gray-700 cursor-pointer flex justify-between items-center group transition";
            div.innerHTML = `<div><div class="text-xs font-bold text-white group-hover:text-accent">${m.name}</div><div class="text-[9px] text-gray-500 uppercase">Ticker: ${m.ticker}</div></div><i class="fa-solid fa-chevron-right text-gray-500"></i>`;
            div.onclick = () => UI.Modals.openDetails(m.id);
            res.appendChild(div);
        });
    },

    renderArchive: () => {
        const tb = document.getElementById('archive-body');
        const empty = document.getElementById('empty-archive');
        if(!tb) return;
        tb.innerHTML = '';
        let total = 0;
        Store.state.history.slice().reverse().forEach((h, i) => {
            total += h.realizedPL || 0;
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td class="pl-6 text-[10px] text-gray-500 font-mono">${new Date(h.sellDate).toLocaleDateString()}</td>
                <td class="font-bold text-xs">${h.name}</td>
                <td class="text-[10px] text-gray-400 italic">${h.reason}</td>
                <td class="text-right mono text-xs">${h.qty || '-'} Stk.</td>
                <td class="text-right mono text-xs font-bold ${h.realizedPL>=0?'text-success':'text-danger'}">${h.realizedPL.toFixed(2)} €</td>
                <td class="text-center">
                    <button onclick="UI.Modals.openRestore(${Store.state.history.length-1-i})" class="text-blue-500 hover:text-white px-2" title="Wiederherstellen"><i class="fa-solid fa-rotate-left"></i></button>
                    <button onclick="if(confirm('Löschen?')){Store.state.history.splice(${Store.state.history.length-1-i},1); Store.commit(); UI.render();}" class="text-gray-700 hover:text-white px-1" title="Löschen"><i class="fa-solid fa-trash"></i></button>
                </td>
            `;
            tb.appendChild(tr);
        });
        const totalEl = document.getElementById('archive-total-pl');
        if(totalEl) totalEl.innerText = `Gesamt G/V: ${total.toFixed(2)} €`;
        if(empty) empty.classList.toggle('hidden', Store.state.history.length > 0);
    },

    Modals: {
        openSearch: () => { document.getElementById('modal-search').classList.remove('hidden'); document.getElementById('search-input').focus(); },
        openDetails: (id) => { 
            const a = Store.state.masterData.find(x => x.id == id);
            if(!a) return;
            document.getElementById('final-index').value = id; 
            document.getElementById('modal-search').classList.add('hidden');
            document.getElementById('modal-add-details').classList.remove('hidden'); 
            document.getElementById('final-qty').focus();
        },
        openBuyMore: (idx) => {
            const a = Store.state.assets[idx];
            document.getElementById('buy-more-idx').value = idx;
            document.getElementById('modal-buy-more').classList.remove('hidden');
            document.getElementById('buy-more-qty').focus();
        },
        openSell: (idx) => { 
            const a = Store.state.assets[idx];
            document.getElementById('sell-idx').value = idx; 
            document.getElementById('sell-qty').value = a.qty;
            document.getElementById('sell-max-qty').innerText = a.qty;
            document.getElementById('sell-price').value = a.livePrice || a.buyPrice;
            document.getElementById('modal-sell').classList.remove('hidden'); 
        },
        openRestore: (idx) => {
            const h = Store.state.history[idx];
            document.getElementById('restore-idx').value = idx;
            document.getElementById('restore-max-qty').innerText = h.qty || 'N/A';
            document.getElementById('restore-qty').value = h.qty || 0;
            document.getElementById('restore-price').value = h.sellPrice || 0; 
            document.getElementById('modal-restore').classList.remove('hidden');
        },
        close: () => document.querySelectorAll('[id^="modal-"]').forEach(m => m.classList.add('hidden')),
        openShare: () => { 
            document.getElementById('modal-share').classList.remove('hidden'); 
            const qrBox = document.getElementById('qrcode');
            qrBox.innerHTML = "";
            new QRCode(qrBox, { text: "https://meteuenal-dashboard.github.io/Finanz-Headquarter/", width: 128, height: 128 });
        },
        shareWhatsApp: () => {
            const url = "https://meteuenal-dashboard.github.io/Finanz-Headquarter/";
            const text = "Finanz-Dashboard: " + url;
            window.open(`https://wa.me/?text=${encodeURIComponent(text)}`);
        }
    }
};

const Market = {
    proxy: 'https://corsproxy.io/?',
    fallbackProxy: 'https://api.allorigins.win/raw?url=',
    
    fetchWithRetry: async (url, options = {}, retries = 5, delay = 1000) => {
        try {
            const res = await fetch(url, options);
            if (!res.ok) throw new Error(`HTTP ${res.status}`);
            return res;
        } catch (e) {
            if (retries <= 0) throw e;
            await new Promise(r => setTimeout(r, delay));
            return Market.fetchWithRetry(url, options, retries - 1, delay * 2);
        }
    },

    loadSheet: async (skipRender = false) => {
        const indicator = document.getElementById('sync-indicator');
        const statusText = document.getElementById('market-status');
        const statusDot = document.getElementById('status-dot');
        const dbTime = document.getElementById('db-update-time');
        const loadingEl = document.getElementById('expert-loading');
        
        if(indicator) indicator.classList.remove('hidden');
        if(statusText) statusText.innerText = "UPDATING...";
        if(statusDot) statusDot.classList.add('animate-ping');
        
        // SHOW LOADING OVERLAY IN TABLE
        if(loadingEl) loadingEl.classList.remove('hidden');
        
        try {
            // AGGRESSIVE CACHE BUSTER: FORCE NEW DATA FROM SERVER
            const unique = Date.now();
            const timestampedUrl = `${CSV_URL}&_cb=${unique}&nocache=true`;
            
            let csvData = "";
            
            // 1. Direct Fetch attempt
            try { 
                const res = await fetch(timestampedUrl, { cache: "no-store", headers: { 'Pragma': 'no-cache', 'Cache-Control': 'no-cache, no-store, must-revalidate' } });
                if(res.ok) csvData = await res.text();
            } catch (e) { console.warn("Direct fetch failed."); }

            // 2. Proxy 1
            if (!csvData) {
                try {
                    const proxyUrl = `${Market.proxy}${encodeURIComponent(timestampedUrl)}&random=${unique}`; 
                    const res = await Market.fetchWithRetry(proxyUrl, { cache: "no-store" });
                    csvData = await res.text();
                } catch(e) { console.warn("Primary Proxy failed."); }
            }

            // 3. Proxy 2
            if (!csvData) {
                 try {
                    const fallbackUrl = `${Market.fallbackProxy}${encodeURIComponent(timestampedUrl)}&_=${unique}`;
                    const res = await Market.fetchWithRetry(fallbackUrl, { cache: "no-store" });
                    csvData = await res.text();
                } catch(e) { console.warn("Fallback Proxy failed."); }
            }

            if (!csvData || csvData.length < 50) throw new Error("Keine validen CSV Daten.");

            const rows = csvData.split('\n').filter(r => r.trim() !== '').map(row => {
                const parts = row.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/);
                return parts ? parts.map(p => p.trim().replace(/^"|"$/g, '')) : [];
            });

            Store.state.masterData = rows.slice(1).map((r, i) => {
                if(r.length < 5) return null;

                let rawPrice = r[2] || "0";
                
                if (rawPrice.includes('(-)') || rawPrice.trim() === '-') return null;
                rawPrice = rawPrice.replace(/[^0-9.,-]/g, '').replace(',', '.');
                const price = parseFloat(rawPrice) || 0;

                let rawChange = r[3] || "0";
                rawChange = rawChange.replace(/[^0-9.,-]/g, '').replace(',', '.');
                const change = parseFloat(rawChange) || 0;

                let rawKgv = r[4] || "0"; 
                const kgv = parseFloat(rawKgv.replace(',', '.')) || 0;
                
                const sector = r[5] || 'Sonstige'; 
                const region = r[6] || 'Global';
                
                let rawDiv = r[7] || "0";
                rawDiv = rawDiv.replace('%', '').replace(',', '.').trim();
                const div = parseFloat(rawDiv) || 0;

                let rawTickerStr = r[1] || 'N/A';
                
                let displayTicker = rawTickerStr;
                if(rawTickerStr.includes(':')) {
                    displayTicker = rawTickerStr.split(':')[1];
                }
                
                return {
                    id: i,
                    name: r[0] || 'Unbenannt',
                    ticker: displayTicker, 
                    fullTicker: rawTickerStr, 
                    wkn: r[2] || '', 
                    isin: r[3] || '',
                    sector: sector, 
                    region: region, 
                    div: div, 
                    price: price, 
                    change: change, 
                    kgv: kgv 
                };
            }).filter(a => a !== null && a.name !== 'Unbenannt' && a.price > 0);

            Store.state.assets.forEach(asset => {
                let match = null;
                if (asset.sheetId !== undefined) {
                    match = Store.state.masterData.find(m => m.id === asset.sheetId);
                }
                if (!match) {
                    const aIsin = asset.isin ? asset.isin.trim().toLowerCase() : '';
                    match = Store.state.masterData.find(m => (m.isin && m.isin.toLowerCase() === aIsin) || (m.name === asset.name));
                    if (match) asset.sheetId = match.id;
                }

                if (match) {
                    const mPrice = Number(match.price);
                    if (!isNaN(mPrice)) asset.livePrice = mPrice;
                    asset.dayChg = match.change;
                    asset.kgv = match.kgv;
                    asset.div = match.div;
                }
            });
            Store.commit();
            
            if (!skipRender) {
                // CLEAR TABLE BRIEFLY TO SHOW "FLASH" UPDATE EFFECT
                const tb = document.getElementById('expert-body');
                if(tb) tb.innerHTML = '';
                setTimeout(() => UI.renderExperts(), 100); 
            }
            
            if(loadingEl) loadingEl.classList.add('hidden');
            
            Market.syncTicker(); 
            
            if(statusText) statusText.innerText = "LIVE";
            if(statusDot) {
                statusDot.classList.remove('animate-ping', 'bg-red-500');
                statusDot.classList.add('animate-pulse', 'bg-emerald-500');
            }
            // UPDATE TIMESTAMP VISIBLY
            if(dbTime) dbTime.innerText = "Stand: " + new Date().toLocaleTimeString('de-DE', {hour: '2-digit', minute:'2-digit', second:'2-digit'});

        } catch (e) {
            console.error("Sheet Sync Fehler:", e);
            if(statusText) statusText.innerText = "OFFLINE";
            if(statusDot) {
                statusDot.classList.remove('bg-emerald-500', 'animate-pulse');
                statusDot.classList.add('bg-red-500');
            }
            if(loadingEl) loadingEl.classList.add('hidden');
        }
        if(indicator) indicator.classList.add('hidden');
    },

    refreshPortfolio: async () => {
        const btn = document.getElementById('btn-portfolio-update');
        if(btn) btn.innerHTML = '<i class="fa-solid fa-spin fa-rotate"></i> Sync...';
        await Market.loadSheet(true); 
        UI.render();
        if(btn) btn.innerHTML = '<i class="fa-solid fa-rotate"></i> Kurse';
    },

    syncTicker: () => {
        const data = Store.state.masterData;
        if(!data || data.length === 0) return;
        let html = "";
        const validAssets = data.filter(a => a.price > 0);
        const dynamicDuration = Math.max(50, validAssets.length * 6); 
        validAssets.forEach(a => {
             const color = a.change >= 0 ? 'ticker-up' : 'ticker-down';
             const sign = a.change >= 0 ? '+' : '';
             html += `<div class="ticker-item"><span class="font-bold text-white">${a.ticker}</span> <span class="ticker-val ${color}">${a.price.toFixed(2)} (${sign}${a.change.toFixed(2)}%)</span></div>`;
        });
        const bar = document.getElementById('live-ticker-bar');
        if(bar && html) {
            bar.innerHTML = html + html; 
            bar.style.animationDuration = `${dynamicDuration}s`;
        }
    },

    syncAll: async (force = false) => {
        const btn = document.getElementById('btnRefresh');
        if(btn) btn.innerHTML = '<i class="fa-solid fa-spin fa-rotate"></i> ...';
        await Market.loadSheet();
        UI.render();
        if(btn) btn.innerHTML = '<i class="fa-solid fa-rotate"></i> <span class="hidden md:inline">Update</span>';
    }
};

const Core = {
    addExec: (e) => {
        e.preventDefault();
        const id = document.getElementById('final-index').value;
        const ref = Store.state.masterData.find(x => x.id == id);
        if(!ref) return;
        Store.state.assets.push({
            ...ref,
            qty: parseFloat(document.getElementById('final-qty').value) || 0,
            buyPrice: parseFloat(document.getElementById('final-buy').value) || 0,
            livePrice: ref.price, 
            dayChg: ref.change, 
            id: Date.now(),
            sheetId: ref.id 
        });
        Store.commit(); 
        UI.Modals.close(); 
        UI.render();
    },
    buyMoreExec: (e) => {
        e.preventDefault();
        const idx = document.getElementById('buy-more-idx').value;
        const addQty = parseFloat(document.getElementById('buy-more-qty').value);
        const addPrice = parseFloat(document.getElementById('buy-more-price').value);
        const asset = Store.state.assets[idx];
        const totalCostOld = asset.qty * asset.buyPrice;
        const totalCostNew = addQty * addPrice;
        const newQty = asset.qty + addQty;
        const newAvgPrice = (totalCostOld + totalCostNew) / newQty;
        asset.qty = newQty;
        asset.buyPrice = newAvgPrice;
        Store.commit();
        UI.Modals.close();
        UI.render();
    },
    sellExec: (e) => {
        e.preventDefault();
        const idx = document.getElementById('sell-idx').value;
        const sellQty = parseFloat(document.getElementById('sell-qty').value);
        const sellPrice = parseFloat(document.getElementById('sell-price').value);
        const reason = document.getElementById('sell-reason').value;
        const a = Store.state.assets[idx];
        if (sellQty > a.qty) {
            alert("Fehler: Verkaufsmenge größer als Bestand!");
            return;
        }
        Store.state.history.push({
            ...a, 
            qty: sellQty,
            sellPrice: sellPrice, 
            reason: reason, 
            sellDate: new Date().toISOString(), 
            realizedPL: (sellPrice - a.buyPrice) * sellQty
        });
        if (sellQty >= a.qty) {
            Store.state.assets.splice(idx, 1);
        } else {
            a.qty -= sellQty;
        }
        Store.commit(); UI.Modals.close(); UI.render();
    },
    restoreExec: (e) => {
        e.preventDefault();
        const idx = document.getElementById('restore-idx').value;
        const restoreQty = parseFloat(document.getElementById('restore-qty').value);
        const restorePrice = parseFloat(document.getElementById('restore-price').value);
        const h = Store.state.history[idx];
        if (restoreQty > h.qty) {
            alert("Fehler: Menge größer als im Archiv!");
            return;
        }
        const existingIdx = Store.state.assets.findIndex(a => a.ticker === h.ticker);
        if (existingIdx >= 0) {
            const asset = Store.state.assets[existingIdx];
            const totalCostOld = asset.qty * asset.buyPrice;
            const totalCostNew = restoreQty * restorePrice;
            asset.qty += restoreQty;
            asset.buyPrice = (totalCostOld + totalCostNew) / asset.qty;
        } else {
            Store.state.assets.push({
                ...h,
                qty: restoreQty,
                buyPrice: restorePrice,
                livePrice: 0, 
                dayChg: 0,
                id: Date.now()
            });
        }
        if (restoreQty >= h.qty) {
            Store.state.history.splice(idx, 1);
        } else {
            h.qty -= restoreQty;
        }
        Store.commit(); UI.Modals.close(); UI.render();
    }
};

const App = {
    router: (v) => {
        // Updated views array - Analytics REMOVED
        const views = ['dashboard','planning','archive','ai'];
        
        // Reset all
        views.forEach(id => {
            const view = document.getElementById('view-'+id);
            const nav = document.getElementById('nav-'+id);
            const mob = document.getElementById('mob-'+id);
            
            // STRICT HIDING LOGIC
            if(view) view.classList.add('hidden');
            
            // Desktop reset
            if(nav) {
                let cls = "px-5 py-1.5 rounded text-xs font-semibold transition-all text-gray-400 hover:text-white";
                if(id === 'ai') cls += " flex items-center gap-2";
                nav.className = cls;
            }
            
            // Mobile reset
            if(mob) {
                mob.classList.remove('active');
                mob.classList.add('text-gray-500');
            }
        });
        
        // Activate target
        const activeView = document.getElementById('view-'+v);
        const activeNav = document.getElementById('nav-'+v);
        const activeMob = document.getElementById('mob-'+v);
        
        if(activeView) activeView.classList.remove('hidden');
        
        if(activeNav) {
             let cls = "px-5 py-1.5 rounded text-xs font-semibold text-blue-100 bg-blue-900 shadow-md transition-all";
             if(v === 'ai') cls += " flex items-center gap-2";
             activeNav.className = cls;
        }
        
        if(activeMob) {
            activeMob.classList.add('active');
            activeMob.classList.remove('text-gray-500');
        }

        if(v === 'ai') AI.render();
        if(v === 'planning') Planner.calc(); 
        if(v === 'dashboard') UI.render(); 
    },
    init: () => {
        if(window.location.protocol === 'file:') {
            console.warn("Hinweis: Datei wird lokal ausgeführt.");
        }
        const p = Store.state.plan;
        const setVal = (id, val) => { const el = document.getElementById(id); if(el) el.value = val; };
        
        setVal('plan-owner', Store.state.owner || "");
        setVal('plan-goal', p.goal);
        setVal('plan-age', p.age);
        setVal('plan-target', p.target);
        setVal('plan-save', p.save);
        setVal('plan-return', p.ret);
        setVal('plan-yield', p.yld);
        
        Market.syncAll();
        // INTERVAL CHANGED FROM 5 MINUTES (300000) TO 1 MINUTE (60000)
        setInterval(() => Market.syncAll(), 60000);
        setTimeout(() => Planner.calc(), 500); 
    }
};

window.onload = App.init;
</script>
</body>
</html>
